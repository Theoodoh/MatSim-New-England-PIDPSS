%% this m-file perfrmes small-signal analysis
initDyn


% x = [13.4601       14.486      1.86073      2.20145      7.85216      11.0467       8.6726      44.0001     0.448353    0.0595272     0.577295    0.0332018     0.957016     0.170889     0.160099     0.652017    0.0376843    0.0578251     0.811232     0.300913     0.378512     0.201703     0.691069     0.813853     0.100578     0.551277     0.157877     0.578775     0.131527     0.868747    0.0361131     0.981706     0.114211     0.130038     0.653631     0.102187     0.357446     0.159516    0.0253695     0.116666     0.322754     0.702765     0.148756     0.836226     0.488102      13.8008     0.941983     0.866862    0.0826824      11.3687     0.170447      15.1217      2.73019     0.148554      17.4615      4.72948      3.61289      1.84648      9.75488      4.68102    0.0494621      18.7821    0.0115918      15.4941     0.689821      2.00596      15.1465        3.974    0.0750772       7.4331      4.74953      9.62152];
% x = [7.21723      5.80686      2.44389      20.9322      2.12592      2.86517      4.31209      9.10379      7.44241     0.183076     0.203445     0.192581     0.161352     0.109851    0.0906488     0.269177    0.0630059     0.143749    0.0652576     0.519438    0.0347343     0.156494    0.0427636     0.218374     0.330823     0.273125    0.0799896     0.173968    0.0493756     0.258094     0.172514     0.236608     0.159278    0.0859048      0.17417    0.0992117       0.5564     0.182053     0.167526     0.224203     0.103944     0.167131     0.108967    0.0846604     0.114215      4.85439      4.04092       8.8797      7.84292      8.36804      5.13553      5.99305      5.79655      8.95698      8.64029      4.91965      11.0371        5.317      2.94142      13.0019      14.3301      6.40534      8.22082      8.87536       8.5751      1.57027      9.99613      3.75433      5.35924     0.992735      2.16175      4.81831];
% x = [12.6714      11.8632      7.31219      1.02387      9.90718      2.33743      3.68781      27.3665      6.23292     0.186539    0.0578544     0.499837     0.217665     0.638466    0.0532647     0.223376    0.0600292      0.20736    0.0310304     0.140785     0.308528    0.0773011      0.16393     0.285187     0.722782     0.268928    0.0389427     0.257776     0.161303     0.720209     0.194564     0.752618     0.486821     0.846357    0.0453803     0.208483     0.266616     0.222839    0.0311345     0.127274    0.0911414     0.163505     0.342307     0.379503     0.136948      1.71196      6.00138      1.89001      4.36861      2.77751      1.31566      15.0515     0.698611      9.03408      2.29181      2.45764      1.53346      1.84927      2.13819      3.14595      0.89829      3.74688      3.07278      3.08755      5.21833      3.97404      19.7746        1.751      4.97365      7.40194      4.01061      7.79543];
% x = [13.5758      37.3454      14.7336       12.078      10.2257      23.9397      15.6486      12.8298      15.9535    0.0124653  0.000669137     0.133083   0.00241864     0.012564   0.00609604     0.125036   0.00044983    0.0171384    0.0045347     0.139465    0.0187504   0.00313206   0.00291622     0.321027     0.073334    0.0483552    0.0033219      0.52106     0.204204    0.0171055    0.0031858     0.251268     0.653754    0.0145736  0.000989388     0.096234       1.0552   0.00694057  0.000540115     0.430005     0.176398   0.00322594    0.0116331     0.454222     0.417462      12.9523      6.12346      3.22825      2.87671      4.53653       2.0108      2.57558     0.792055      1.32077      1.17783     0.837871      4.67532      2.05256       4.4908      3.12338     0.741134      3.35728      4.02158      2.69435      2.54203      3.31455     0.858761      3.07633       2.3092     0.164929     0.764276      1.68655];
% x = [35.8276       17.069      17.2136      18.3767      16.1075      15.4235      10.4372       17.809      16.0958    0.0304636   0.00447453     0.866474       1.7008    0.0429563    0.0235194     0.593097     0.447293    0.0242453    0.0203773    0.0157909      1.84561    0.0305107   0.00346301      0.53525      0.76986    0.0362158   0.00655117     0.316598       1.7428    0.0331516     0.014059     0.467224     0.181728    0.0132944    0.0115789     0.352095       1.1706    0.0207712   0.00586429     0.682511     0.526907    0.0400446    0.0282514     0.572087    0.0114558      3.53983      2.57328       5.7082      1.28374      1.84418      8.08433      7.32382      4.34476     0.254023      10.0838      2.87334      7.15817     0.813534      1.40074      5.34068       7.3209      9.30824      19.1402      6.20854      3.98666      8.65135      0.82922      3.40157      4.83151      3.49733      4.46626      12.9564];
% x = [13.4586      10.8376      10.4289      27.6596      21.4772      14.6187       20.943      20.5887      25.9921    0.0268792   0.00627959     0.185892     0.135684   0.00704792   0.00207293     0.670722      1.19124    0.0394942   0.00793389      0.64083     0.978964    0.0248219   0.00437451     0.347568     0.362426    0.0320983    0.0141597     0.383412     0.441286     0.022218    0.0142945     0.297212      1.68442    0.0321597  2.15139e-05      0.34154     0.537141    0.0432599   0.00248987      0.43191     0.567756    0.0204032   0.00598435     0.279974      1.57375     0.442323      10.3342      6.63029      2.22738      2.40278      10.1242     0.344008      3.22083      7.77518      9.14957       1.7601      11.7375     0.162348     0.156501      2.16436       9.7697     0.181759      1.68348      4.95736      7.80624      5.56962   0.00587874      6.05678      4.14306       11.919      5.96391      7.02176];
% x = [32.3008      19.0798      23.9462      10.5888      10.2539      12.4775      13.2409       34.994      25.6455     0.045334   0.00382674     0.541559      1.14456     0.020213   0.00204589     0.308204     0.603668    0.0416272   0.00393854     0.340759       1.3611    0.0439722   0.00636283     0.706992       1.7245    0.0393094    0.0067902     0.740464     0.768395     0.034059    0.0225806     0.314383    0.0354644    0.0229356   0.00892951     0.455825      1.02292    0.0328031   0.00678405     0.189103     0.249128    0.0185231    0.0023349     0.383605     0.275616      0.76633      3.00149      7.53071   0.00792158      4.92984      7.39836      4.70163      9.76329      7.15125      7.23643      1.57843      4.45777      12.8856      9.17017      7.26638      1.54361      4.23343      2.64671      11.5476     0.291381      9.29081      2.83183      11.1578      10.8874      7.20359      9.13838      12.5675];
% x = [32.2537      26.9246      40.5502      27.9016      16.1956      15.4907       10.761      34.3812      11.2214    0.0496707   0.00835123     0.142701    0.0113633    0.0103151   0.00397418     0.348711     0.150404   0.00491337    0.0033628     0.140245     0.180908   0.00409369   0.00609368     0.290039    0.0466971    0.0049058   0.00418439     0.144888     0.699762   0.00730164   0.00378074      0.28902    0.0778932    0.0239264   0.00172723     0.113721     0.059465   0.00345105   0.00248548    0.0889089   0.00937956    0.0468474   0.00185187    0.0494831      0.34614     0.429173     0.449597     0.977617     0.524483      1.42624      2.54272      1.12515      2.76047      2.88952      1.67349     0.127377     0.763652      3.35265     0.111464     0.645473       1.3824     0.154221      1.44916      1.74871      1.23837      3.27318      1.83322      1.35475      1.38086      0.94808       1.2617       2.7052];
x = [40.9266      10.1753      32.2287      36.7316      10.4756      11.9469      24.6746       42.242      15.8187    0.0469107    0.0145164     0.577243     0.456326    0.0125994  0.000479444     0.558063     0.132892    0.0466721   0.00919158     0.941396     0.927427   0.00366039  0.000561074      0.50241      0.68998    0.0189946   0.00720568     0.579843     0.380758    0.0215812   0.00586684     0.156349      1.89366   0.00672409  0.000921055     0.212602    0.0767579    0.0350591   0.00293216     0.196062    0.0760665   0.00536887   0.00124239    0.0565335     0.301302     0.940519      0.92003      1.06444     0.567075     0.695573      2.87977     0.258394   0.00485576      2.42447        1.947     0.652255      1.87051     0.177935      1.49365      4.25751      1.52982     0.579096     0.718991     0.702804     0.467815      1.15891      6.26168      0.70893      2.68413      16.5302      3.63178      11.9661];
% x = [36.3632      13.1331      14.2434      15.0892      16.5908      10.0015      17.9372      10.7043       23.665    0.0419472    0.0148463     0.539212     0.638046    0.0200683    0.0011724     0.445142      1.29323    0.0440557   0.00030935     0.420684      1.54836    0.0453683   4.5558e-05     0.426546      1.18681    0.0256796    0.0286521      0.40177      1.61842    0.0274551   0.00462077     0.855242     0.674235    0.0376269   0.00694698     0.502465      0.43211    0.0248674  0.000588335     0.318119     0.446933    0.0336356    0.0388514     0.250579      1.02603      5.50232      8.04875      7.40724      5.42818     0.642662      12.8944      10.5722      10.4347      12.1972      5.61856      2.83656      11.1103      2.78881      5.10323      6.11552      7.67353      8.50853      6.10618      4.98925     0.242236      3.30064      8.51324      7.75854      9.95423      9.05356      7.61607      16.1779];


Tw = 10;
%% G1
KG1 = x(1);
T11 = x(10);
T12 = x(11);
T13 = x(12);
T14 = x(13);
P1 = x(46);
I1 = x(47);
D1 = x(48);
Kpss1 = KG1*T11*T13/(T12*T14);

KG3 = x(2);
T31 = x(14);
T32 = x(15);
T33 = x(16);
T34 = x(17);
P3 = x(49);
I3 = x(50);
D3 = x(51);
Kpss3 =  KG3*T31*T33/(T32*T34);

KG4 = x(3);
T41 = x(18);
T42 = x(19);
T43 = x(20);
T44 = x(21);
P4 = x(52);
I4 = x(53);
D4 = x(54);
Kpss4 =  KG4*T41*T43/(T42*T44);

KG5 = x(4);
T51 = x(22);
T52 = x(23);
T53 = x(24);
T54 = x(25);
P5 = x(55);
I5 = x(56);
D5 = x(57);
Kpss5 =  KG5*T51*T53/(T52*T54);

KG6 = x(5);
T61 = x(26);
T62 = x(27);
T63 = x(28);
T64 = x(29);
P6 = x(58);
I6 = x(59);
D6 = x(60);
Kpss6 =  KG6*T61*T63/(T62*T64);

KG7 = x(6);
T71 = x(30);
T72 = x(31);
T73 = x(32);
T74 = x(33);
P7 = x(61);
I7 = x(62);
D7 = x(63);
Kpss7 =  KG7*T71*T73/(T72*T74);

KG8 = x(7);
T81 = x(34);
T82 = x(35);
T83 = x(36);
T84 = x(37);
P8 = x(64);
I8 = x(65);
D8 = x(66);
Kpss8 =  KG8*T81*T83/(T82*T84);

KG9 = x(8);
T91 = x(38);
T92 = x(39);
T93 = x(40);
T94 = x(41);
P9 = x(67);
I9 = x(68);
D9 = x(69);
Kpss9 =  KG9*T91*T93/(T92*T94);

KG10 = x(9);
T101 = x(42);
T102 = x(43);
T103 = x(44);
T104 = x(45);
P10 = x(70);
I10= x(71);
D10= x(72);
Kpss10 =  KG10*T101*T103/(T102*T104);

%% Linearize Power System
% f11=linmod('sys10m');
f11=linmod('sys10m_pss');

% dx/dt = A.x + B.u
% y = C.x + D.u

Asys = f11.a ;
Bsys = f11.b ;
Csys = f11.c ;
Dsys = f11.d ;

%% Calculate Eigenvalues
egs = eig(Asys)
Ns = length(egs);
Damp=-real(egs)./sqrt(real(egs).^2+imag(egs).^2)
freq=abs(imag(egs))/(2*pi)

%% calculae Participation Factors
[Vs,D_eig] = eig(Asys);
Ws=inv(Vs);
for i=1:Ns
    for k=1:Ns
        Pfact1(k,i)=abs(Vs(k,i))*abs(Ws(i,k));
    end
end

for i=1:Ns
     Pfact(i,:)=Pfact1(i,:)/sum(Pfact1(i,:));
end

for i=1:Ns
    [s_val s_idx]=sort(Pfact(:,i),'descend');
    mod_idx(i,:)=s_idx(1:4)';
    pf_fact(i,:)=s_val(1:4)';
end
mod_idx;
pf_fact;

idx_zero = find(abs(egs)<1e-6)
EG_new = egs;
EG_new(idx_zero)=[];

idx_EMs = find(max(real(EG_new)))
EMs = EG_new(idx_EMs)
